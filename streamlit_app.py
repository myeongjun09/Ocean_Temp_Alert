import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm

# Matplotlib í•œê¸€ í°íŠ¸ ì„¤ì •
# ì‹œìŠ¤í…œì— ë‚˜ëˆ”ê³ ë”•ì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•Šë‹¤ë©´ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
# ì•„ë˜ ì½”ë“œëŠ” ë¡œì»¬ í™˜ê²½ì—ì„œ ë‚˜ëˆ”ê³ ë”• í°íŠ¸ê°€ ì„¤ì¹˜ë˜ì–´ ìˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
try:
    font_path = fm.findfont(fm.FontProperties(family='NanumGothic'))
    plt.rc('font', family='NanumGothic')
    plt.rcParams['axes.unicode_minus'] = False
except:
    # ë‚˜ëˆ”ê³ ë”• í°íŠ¸ê°€ ì—†ì„ ê²½ìš° ë‹¤ë¥¸ í°íŠ¸ ì‚¬ìš©
    # ì˜ˆ: Windows í™˜ê²½ì˜ ë§‘ì€ ê³ ë”•
    plt.rc('font', family='Malgun Gothic')
    plt.rcParams['axes.unicode_minus'] = False

# -----------------------
# í˜ì´ì§€ ê¸°ë³¸ ì„¤ì •
# -----------------------
st.set_page_config(
    page_title="ë°”ë‹¤ì˜ ì˜¨ë„ ê²½ê³ ìŒ",
    page_icon="ğŸŒŠ",
    layout="wide"
)

# -----------------------
# ì œëª©
# -----------------------
st.title("ğŸŒŠ ë°”ë‹¤ì˜ ì˜¨ë„ ê²½ê³ ìŒ: í•´ìˆ˜ì˜¨ ìƒìŠ¹ê³¼ ì§€ì† ê°€ëŠ¥í•œ í•´ê²°ì±…")
st.markdown("""
ì´ ì•±ì€ í•´ìˆ˜ì˜¨ ìƒìŠ¹ì˜ ì›ì¸ê³¼ ì˜í–¥ì„ ë¶„ì„í•˜ê³ , ë°ì´í„°ë¥¼ ì‹œê°í™”í•˜ì—¬ ë³´ì—¬ì¤ë‹ˆë‹¤. 
ë˜í•œ ì‚¬ìš©ìê°€ ì§ì ‘ **ì—°ë„ ë²”ìœ„ì™€ ì§€ì—­**ì„ ì„ íƒí•´ ë³€í™”ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
""")

# -----------------------
# ì‚¬ì´ë“œë°”: ì§€ì—­, ì—°ë„, ê·¸ë˜í”„ ì„ íƒ
# -----------------------
st.sidebar.header("ğŸŒ ì§€ì—­ ì„ íƒ")
regions = ["ì „ ì„¸ê³„", "í•œêµ­ ì—°ì•ˆ", "íƒœí‰ì–‘", "ëŒ€ì„œì–‘", "ì¸ë„ì–‘", "ë¶ê·¹í•´", "ë‚¨ê·¹í•´"]
selected_region = st.sidebar.selectbox("ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”", regions)

st.sidebar.header("ğŸ“… ì—°ë„ ì„ íƒ")
years = np.arange(2000, 2026)
year_range = st.sidebar.slider(
    "ì—°ë„ ë²”ìœ„ë¥¼ ì„ íƒí•˜ì„¸ìš”",
    min_value=int(years.min()),
    max_value=int(years.max()),
    value=(2010, 2020)
)

st.sidebar.header("ğŸ“ˆ ê·¸ë˜í”„ ì„¤ì •")
chart_type = st.sidebar.selectbox(
    "ê·¸ë˜í”„ ì¢…ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”",
    ["ì„  ê·¸ë˜í”„", "ë§‰ëŒ€ ê·¸ë˜í”„"]
)

st.sidebar.header("ğŸ“‹ ì„¤ë¬¸ì¡°ì‚¬ ì„ íƒ")
survey_options = st.sidebar.multiselect(
    "ë³´ê³  ì‹¶ì€ ì„¤ë¬¸ í•­ëª© ì„ íƒ",
    ["í•´ìˆ˜ì˜¨ ìƒìŠ¹ì˜ ì›ì¸", "ì˜í–¥ ì¸ì‹ ì •ë„", "ê°€ì¥ íš¨ê³¼ì ì¸ í•´ê²° ë°©ë²•", "ì¼ìƒ ì‹¤ì²œ ë°©ì•ˆ"],
    default=["í•´ìˆ˜ì˜¨ ìƒìŠ¹ì˜ ì›ì¸", "ê°€ì¥ íš¨ê³¼ì ì¸ í•´ê²° ë°©ë²•"]
)

# -----------------------
# ì˜ˆì‹œ ë°ì´í„° ìƒì„±
# -----------------------
region_temp_offset = {
    "ì „ ì„¸ê³„": 0,
    "í•œêµ­ ì—°ì•ˆ": 0.2,
    "íƒœí‰ì–‘": 0.3,
    "ëŒ€ì„œì–‘": 0.1,
    "ì¸ë„ì–‘": 0.25,
    "ë¶ê·¹í•´": 1.0,
    "ë‚¨ê·¹í•´": 0.8
}
temperatures = 15 + region_temp_offset[selected_region] + 0.03 * (years - 2000) + np.random.normal(0, 0.1, len(years))
df_temp = pd.DataFrame({"ì—°ë„": years, "í‰ê·  í•´ìˆ˜ì˜¨ë„(Â°C)": temperatures})
filtered_df = df_temp[(df_temp["ì—°ë„"] >= year_range[0]) & (df_temp["ì—°ë„"] <= year_range[1])]

# -----------------------
# ì„¤ë¬¸ì¡°ì‚¬ ë°ì´í„°
# -----------------------
survey_q1 = pd.DataFrame({
    "ì›ì¸": ["ì˜¨ì‹¤ê°€ìŠ¤ ë°°ì¶œ", "ì‚°ì—… íê¸°ë¬¼", "í•´ì–‘ ì“°ë ˆê¸°", "ê¸°íƒ€"],
    "ì‘ë‹µ ìˆ˜": [2, 1, 0, 1]
})
survey_q2 = pd.DataFrame({
    "ì˜í–¥ ì¸ì‹ ì •ë„": ["1", "2", "3", "4", "5"],
    "ì‘ë‹µ ìˆ˜": [0, 0, 0, 2, 1]
})
survey_q3 = pd.DataFrame({
    "í•´ê²° ë°©ë²•": ["ì˜¨ì‹¤ê°€ìŠ¤ ë°°ì¶œëŸ‰ ì¤„ì´ê¸°", "í•´ì–‘ ë³´í˜¸êµ¬ì—­ ì„¤ì¹˜", "ìì—° ê¸°ë°˜ í•´ë²• í™œìš©", "ê¸°íƒ€"],
    "ì‘ë‹µ ìˆ˜": [2, 1, 0, 1]
})
survey_q4 = pd.DataFrame({
    "ì¼ìƒ ì‹¤ì²œ ë°©ë²•": ["ì—ë„ˆì§€ ì ˆì•½", "ì¼íšŒìš©í’ˆ ì¤„ì´ê¸°", "ëŒ€ì¤‘êµí†µ/ìì „ê±° ì´ìš©", "ì¬í™œìš© ì‹¤ì²œ", "ê¸°íƒ€"],
    "ì‘ë‹µ ìˆ˜": [0, 2, 3, 0, 1]
})
survey_general = pd.DataFrame({
    "ì‘ë‹µ": ["ë§¤ìš° ì‹¬ê°í•˜ë‹¤", "ì‹¬ê°í•˜ë‹¤", "ë³´í†µì´ë‹¤", "ë³„ë¡œ ì‹¬ê°í•˜ì§€ ì•Šë‹¤"],
    "ë¹„ìœ¨(%)": [40, 35, 20, 5]
})

# -----------------------
# íƒ­ êµ¬ì„±: ì„œë¡ , ë³¸ë¡ , ê²°ë¡ 
# -----------------------
tabs = st.tabs(["ì„œë¡ ", "ë³¸ë¡ ", "ê²°ë¡ "])

# -----------------------
# ì„œë¡ 
# -----------------------
with tabs[0]:
    st.header("ì„œë¡ ")
    st.markdown("""
    ì§€êµ¬ ì˜¨ë‚œí™”ëŠ” ì „ ì„¸ê³„ì ìœ¼ë¡œ ì¤‘ìš”í•œ í™˜ê²½ ë¬¸ì œë¡œ ëŒ€ë‘ë˜ê³  ìˆìœ¼ë©°, 
    íŠ¹íˆ í•´ìˆ˜ì˜¨ ìƒìŠ¹ì€ ê¸°í›„ ë³€í™”ì˜ ê°€ì¥ ëšœë ·í•œ ì§•í›„ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. 
    í•´ìˆ˜ì˜¨ ìƒìŠ¹ì€ í•´ì–‘ ìƒíƒœê³„, ê¸°ìƒ íŒ¨í„´, ì¸ë¥˜ ì‚¬íšŒ ì „ë°˜ì— ê±¸ì³ ì‹¬ê°í•œ ì˜í–¥ì„ ë¯¸ì¹˜ê³  ìˆìŠµë‹ˆë‹¤. 
    
    ë³¸ ë³´ê³ ì„œì—ì„œëŠ” í•´ìˆ˜ì˜¨ ìƒìŠ¹ì˜ ì›ì¸ê³¼ ì˜í–¥, 
    ê·¸ë¦¬ê³  ì§€ì† ê°€ëŠ¥í•œ í•´ê²° ë°©ì•ˆì„ í•™ìƒ ì„¤ë¬¸ì¡°ì‚¬ ê²°ê³¼ì™€ ë°ì´í„° ì‹œê°í™”ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¶„ì„í•˜ê³ ì í•©ë‹ˆë‹¤.
    """)

# -----------------------
# ë³¸ë¡ 
# -----------------------
with tabs[1]:
    st.header("ë³¸ë¡ ")

    # --- 1. í•´ìˆ˜ì˜¨ ì¶”ì„¸ ---
    st.subheader(f"ğŸ“Š {selected_region} í•´ìˆ˜ì˜¨ ìƒìŠ¹ ì¶”ì„¸")
    fig, ax = plt.subplots(figsize=(10, 5))
    if chart_type == "ì„  ê·¸ë˜í”„":
        ax.plot(filtered_df["ì—°ë„"], filtered_df["í‰ê·  í•´ìˆ˜ì˜¨ë„(Â°C)"], marker="o", linestyle="-")
    elif chart_type == "ë§‰ëŒ€ ê·¸ë˜í”„":
        ax.bar(filtered_df["ì—°ë„"], filtered_df["í‰ê·  í•´ìˆ˜ì˜¨ë„(Â°C)"])
    
    ax.set_xlabel("ì—°ë„")
    ax.set_ylabel("í‰ê·  í•´ìˆ˜ì˜¨ë„ (Â°C)")
    ax.set_title(f"{selected_region}: {year_range[0]}ë…„ ~ {year_range[1]}ë…„ í•´ìˆ˜ì˜¨ ì¶”ì„¸")
    ax.tick_params(axis='x', rotation=0)
    st.pyplot(fig)
    st.dataframe(filtered_df, use_container_width=True)

    # --- 2. í•´ìˆ˜ì˜¨ ìƒìŠ¹ ì˜í–¥ ---
    st.subheader("ğŸŒ í•´ìˆ˜ì˜¨ ìƒìŠ¹ì˜ ì˜í–¥")
    impact_options = st.multiselect(
        "ê´€ì‹¬ ìˆëŠ” ì˜í–¥ì„ ì„ íƒí•˜ì„¸ìš”",
        ["ì‚°í˜¸ì´ˆ ë°±í™”í˜„ìƒ", "ì–´ë¥˜ ì´ë™ ê²½ë¡œ ë³€í™”", "í•´ì•ˆ ë„ì‹œ ì¹¨ìˆ˜", "ê·¹ì§€ë°© ë¹™í•˜ ê°ì†Œ"],
        default=["ì‚°í˜¸ì´ˆ ë°±í™”í˜„ìƒ", "ì–´ë¥˜ ì´ë™ ê²½ë¡œ ë³€í™”"]
    )
    col1, col2 = st.columns(2)
    
    image_paths = {
        "ì‚°í˜¸ì´ˆ ë°±í™”í˜„ìƒ": "https://upload.wikimedia.org/wikipedia/commons/0/0d/Coral_bleaching.jpg",
        "ì–´ë¥˜ ì´ë™ ê²½ë¡œ ë³€í™”": "https://upload.wikimedia.org/wikipedia/commons/4/49/Fish_school_in_Palau.jpg",
        "í•´ì•ˆ ë„ì‹œ ì¹¨ìˆ˜": "https://upload.wikimedia.org/wikipedia/commons/3/3f/Miami_flooding.jpg",
        "ê·¹ì§€ë°© ë¹™í•˜ ê°ì†Œ": "https://upload.wikimedia.org/wikipedia/commons/f/f3/Melting_Glacier.jpg"
    }

    if "ì‚°í˜¸ì´ˆ ë°±í™”í˜„ìƒ" in impact_options:
        with col1:
            st.markdown("#### ğŸª¸ ì‚°í˜¸ì´ˆ ë°±í™”í˜„ìƒ")
            st.image(image_paths["ì‚°í˜¸ì´ˆ ë°±í™”í˜„ìƒ"], caption="ì‚°í˜¸ì´ˆ ë°±í™”í˜„ìƒ", use_container_width=True)
            st.write("í•´ìˆ˜ì˜¨ ìƒìŠ¹ìœ¼ë¡œ ì¸í•´ ì‚°í˜¸ê°€ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ì•„ ë°±í™”í˜„ìƒì´ ë°œìƒí•˜ë©°, ì´ëŠ” í•´ì–‘ ìƒë¬¼ ë‹¤ì–‘ì„± ê°ì†Œë¡œ ì´ì–´ì§‘ë‹ˆë‹¤.")
    if "ì–´ë¥˜ ì´ë™ ê²½ë¡œ ë³€í™”" in impact_options:
        with col2:
            st.markdown("#### ğŸŸ ì–´ë¥˜ ì´ë™ ê²½ë¡œ ë³€í™”")
            st.image(image_paths["ì–´ë¥˜ ì´ë™ ê²½ë¡œ ë³€í™”"], caption="ì–´ë¥˜ ë¬´ë¦¬ ì´ë™", use_container_width=True)
            st.write("ì–´ë¥˜ëŠ” ì ì • ìˆ˜ì˜¨ì„ ì°¾ì•„ ì´ë™í•˜ëŠ”ë°, ìˆ˜ì˜¨ ìƒìŠ¹ìœ¼ë¡œ ê¸°ì¡´ì˜ ì–´íš ì§€ì—­ì´ ë³€í™”í•˜ì—¬ ì–´ì—… ìƒì‚°ëŸ‰ì— ì˜í–¥ì„ ì¤ë‹ˆë‹¤.")
    if "í•´ì•ˆ ë„ì‹œ ì¹¨ìˆ˜" in impact_options:
        st.markdown("#### ğŸŒ† í•´ì•ˆ ë„ì‹œ ì¹¨ìˆ˜")
        st.image(image_paths["í•´ì•ˆ ë„ì‹œ ì¹¨ìˆ˜"], caption="í•´ìˆ˜ë©´ ìƒìŠ¹ìœ¼ë¡œ ì¸í•œ í•´ì•ˆ ë„ì‹œ ì¹¨ìˆ˜", use_container_width=True)
        st.write("í•´ìˆ˜ì˜¨ ìƒìŠ¹ì€ í•´ìˆ˜ë©´ ìƒìŠ¹ìœ¼ë¡œ ì´ì–´ì ¸, í•´ì•ˆ ë„ì‹œì˜ ì¹¨ìˆ˜ ìœ„í—˜ì„ ì¦ê°€ì‹œí‚µë‹ˆë‹¤.")
    if "ê·¹ì§€ë°© ë¹™í•˜ ê°ì†Œ" in impact_options:
        st.markdown("#### ğŸ§Š ê·¹ì§€ë°© ë¹™í•˜ ê°ì†Œ")
        st.image(image_paths["ê·¹ì§€ë°© ë¹™í•˜ ê°ì†Œ"], caption="ë¹™í•˜ ê°ì†Œ", use_container_width=True)
        st.write("ê·¹ì§€ë°©ì˜ ë¹™í•˜ê°€ ë¹ ë¥´ê²Œ ë…¹ìœ¼ë©´ì„œ ì „ ì„¸ê³„ í•´ìˆ˜ë©´ ìƒìŠ¹ì„ ê°€ì†í™”í•©ë‹ˆë‹¤.")

    # --- 3. ì„¤ë¬¸ì¡°ì‚¬ ---
    st.subheader("ğŸ“‹ ë¯¸ë¦¼ë§ˆì´ìŠ¤í„°ê³  í•™ìƒ ì„¤ë¬¸ì¡°ì‚¬ ê²°ê³¼")
    col1, col2 = st.columns(2)

    if "í•´ìˆ˜ì˜¨ ìƒìŠ¹ì˜ ì›ì¸" in survey_options:
        with col1:
            st.markdown("1ï¸âƒ£ í•´ìˆ˜ì˜¨ ìƒìŠ¹ì˜ ì›ì¸")
            fig, ax = plt.subplots()
            ax.bar(survey_q1["ì›ì¸"], survey_q1["ì‘ë‹µ ìˆ˜"])
            ax.set_title("í•´ìˆ˜ì˜¨ ìƒìŠ¹ì˜ ì›ì¸")
            ax.set_xticklabels(survey_q1["ì›ì¸"], rotation=45, ha='right', fontsize=8)
            plt.tight_layout()
            st.pyplot(fig)

    if "ì˜í–¥ ì¸ì‹ ì •ë„" in survey_options:
        with col1:
            st.markdown("2ï¸âƒ£ ì˜í–¥ ì¸ì‹ ì •ë„")
            fig, ax = plt.subplots()
            ax.bar(survey_q2["ì˜í–¥ ì¸ì‹ ì •ë„"], survey_q2["ì‘ë‹µ ìˆ˜"])
            ax.set_title("ì˜í–¥ ì¸ì‹ ì •ë„")
            plt.tight_layout()
            st.pyplot(fig)

    if "ê°€ì¥ íš¨ê³¼ì ì¸ í•´ê²° ë°©ë²•" in survey_options:
        with col2:
            st.markdown("3ï¸âƒ£ ê°€ì¥ íš¨ê³¼ì ì¸ í•´ê²° ë°©ë²•")
            fig, ax = plt.subplots()
            ax.bar(survey_q3["í•´ê²° ë°©ë²•"], survey_q3["ì‘ë‹µ ìˆ˜"])
            ax.set_title("ê°€ì¥ íš¨ê³¼ì ì¸ í•´ê²° ë°©ë²•")
            ax.set_xticklabels(survey_q3["í•´ê²° ë°©ë²•"], rotation=45, ha='right', fontsize=8)
            plt.tight_layout()
            st.pyplot(fig)

    if "ì¼ìƒ ì‹¤ì²œ ë°©ì•ˆ" in survey_options:
        with col2:
            st.markdown("4ï¸âƒ£ ì¼ìƒ ì‹¤ì²œ ë°©ì•ˆ")
            fig, ax = plt.subplots()
            ax.bar(survey_q4["ì¼ìƒ ì‹¤ì²œ ë°©ë²•"], survey_q4["ì‘ë‹µ ìˆ˜"])
            ax.set_title("ì¼ìƒ ì‹¤ì²œ ë°©ì•ˆ")
            ax.set_xticklabels(survey_q4["ì¼ìƒ ì‹¤ì²œ ë°©ë²•"], rotation=45, ha='right', fontsize=8)
            plt.tight_layout()
            st.pyplot(fig)
            
    st.markdown("**ì „ì²´ í•™ìƒ ì¸ì‹ ì •ë„**")
    fig, ax = plt.subplots()
    ax.bar(survey_general["ì‘ë‹µ"], survey_general["ë¹„ìœ¨(%)"])
    ax.set_title("ì „ì²´ í•™ìƒ ì¸ì‹ ì •ë„")
    plt.tight_layout()
    st.pyplot(fig)

# -----------------------
# ê²°ë¡ 
# -----------------------
with tabs[2]:
    st.header("ê²°ë¡  ë° ì œì–¸")
    st.markdown("""
- í•™ìƒë“¤ì€ í•´ìˆ˜ì˜¨ ìƒìŠ¹ì˜ **ì£¼ìš” ì›ì¸ìœ¼ë¡œ ì˜¨ì‹¤ê°€ìŠ¤ ë°°ì¶œ**ì„ ê¼½ì•˜ìŠµë‹ˆë‹¤. 
- í•´ìˆ˜ì˜¨ ìƒìŠ¹ì˜ **ì˜í–¥ ì¸ì‹ ìˆ˜ì¤€ì€ í‰ê· ì ìœ¼ë¡œ ë†’ì€ í¸(4~5ì )**ìœ¼ë¡œ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤. 
- í•´ê²° ë°©ë²•ìœ¼ë¡œëŠ” **ì˜¨ì‹¤ê°€ìŠ¤ ê°ì¶•ê³¼ í•´ì–‘ ë³´í˜¸êµ¬ì—­ ì„¤ì¹˜**ê°€ ì£¼ìš”í•˜ê²Œ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. 
- ì¼ìƒì—ì„œ ì‹¤ì²œ ê°€ëŠ¥í•œ ë°©ë²•ìœ¼ë¡œëŠ” **ëŒ€ì¤‘êµí†µ/ìì „ê±° ì´ìš©, ì¼íšŒìš©í’ˆ ì¤„ì´ê¸°**ê°€ ë§ì´ ì–¸ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤. 

ë”°ë¼ì„œ, **ê°œì¸ì ì¸ ì‹¤ì²œê³¼ ì •ì±…ì  ë…¸ë ¥ì˜ ë³‘í–‰**ì´ í•„ìš”í•©ë‹ˆë‹¤. 
íŠ¹íˆ êµìœ¡ì„ í†µí•œ ì¸ì‹ ì œê³ ì™€ ì‹¤ì²œ ìŠµê´€ í˜•ì„±ì´ ì¤‘ìš”í•˜ë©°, 
ì¥ê¸°ì ìœ¼ë¡œëŠ” êµ­ì œì  í˜‘ë ¥ê³¼ ì§€ì† ê°€ëŠ¥í•œ í•´ì–‘ ê´€ë¦¬ ì •ì±…ì´ ë’·ë°›ì¹¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
""")

# ì¶”ê°€: ê²°ë¡ ì—ì„œ ì‹¤ì²œ ë°©ì•ˆ íˆ¬í‘œ
solution = st.radio(
    "ë‹¹ì‹ ì´ ê°€ì¥ ì‹¤ì²œí•  ìˆ˜ ìˆë‹¤ê³  ìƒê°í•˜ëŠ” ë°©ë²•ì€?",
    ["ì¼íšŒìš©í’ˆ ì¤„ì´ê¸°", "ëŒ€ì¤‘êµí†µ ì´ìš©", "ì¬í™œìš© ê°•í™”", "ì¹œí™˜ê²½ ì œí’ˆ êµ¬ë§¤"]
)
st.success(f"ğŸ‘ ì„ íƒí•˜ì‹  ì‹¤ì²œ ë°©ì•ˆ: {solution}")
st.info("ì‘ì€ í–‰ë™ì´ ëª¨ì—¬ í° ë³€í™”ë¥¼ ë§Œë“­ë‹ˆë‹¤. ìš°ë¦¬ ëª¨ë‘ê°€ ë°”ë‹¤ì˜ ëª©ì†Œë¦¬ì— ê·€ ê¸°ìš¸ì—¬ì•¼ í•  ë•Œì…ë‹ˆë‹¤.")